{% extends 'loja/barra_lateral.html' %}

{% block title %}Lista de Produtos{% endblock %}

{% block content %}
<div class="container-fluid px-4">

    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="fw-semibold mb-0">Lista de produtos</h2>
            <a href="{% url 'criar_produto' %}" class="btn btn-outline-success">
        <i class="bi bi-box-arrow-in-down"></i> Nova produto
            </a>
    </div>
    

    <!-- Barra de busca + botão de filtros -->
    <div class="row g-2 mb-3">
        <div class="col-md-4">
            <input type="text" id="filtro-nome" class="form-control" placeholder="Pesquisar por nome ou ID...">
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosExtras" aria-expanded="false" aria-controls="filtrosExtras">
                <i class="bi bi-funnel-fill"></i> Filtros
            </button>
        </div>
    </div>

    <!-- Campos extras (colapsáveis) -->
    <div class="collapse mb-3" id="filtrosExtras">
        <div class="row g-2">
            <div class="col-md-2">
                <input type="number" id="preco-min" class="form-control" placeholder="Preço mín.">
            </div>
            <div class="col-md-2">
                <input type="number" id="preco-max" class="form-control" placeholder="Preço máx.">
            </div>
            <div class="col-md-2">
                <input type="number" id="qtd-min" class="form-control" placeholder="Qtd mín.">
            </div>
            <div class="col-md-2">
                <input type="number" id="qtd-max" class="form-control" placeholder="Qtd máx.">
            </div>
            <div class="col-md-2 d-flex">
                <button type="button" id="btn-limpar" class="btn btn-outline-danger w-100">
                    <i class="bi bi-x-circle"></i> Limpar
                </button>
            </div>
        </div>
    </div>

    <!-- Tabela -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped align-middle text-center">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Preço</th>
                            <th>Descrição</th>
                            <th>Quantidade</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-produtos">
                        {% for produto in produtos %}
                        <tr data-id="{{ produto.id }}" 
                            data-nome="{{ produto.nome|lower }}" 
                            data-preco="{{ produto.preco }}" 
                            data-qtd="{{ produto.quantidade }}">
                            <td>{{ produto.id }}</td>
                            <td>{{ produto.nome }}</td>
                            <td>R$ {{ produto.preco }}</td>
                            <td>{{ produto.descricao|truncatechars:50 }}</td>
                            <td>{{ produto.quantidade|default:"Não informada" }}</td>
                            <td>
                                <a href="{% url 'editar_produto' produto.id %}" class="btn btn-sm btn-outline-info">Editar</a>
                                <a href="{% url 'excluir_produto' produto.id %}" class="btn btn-sm btn-outline-danger">Excluir</a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-muted text-center">Nenhum produto cadastrado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
const filtroNome = document.getElementById("filtro-nome");
const precoMin = document.getElementById("preco-min");
const precoMax = document.getElementById("preco-max");
const qtdMin = document.getElementById("qtd-min");
const qtdMax = document.getElementById("qtd-max");
const btnLimpar = document.getElementById("btn-limpar");

const linhas = document.querySelectorAll("#tabela-produtos tr[data-id]");

function aplicarFiltros() {
    const termo = filtroNome.value.trim().toLowerCase();
    const pMin = parseFloat(precoMin?.value) || 0;
    const pMax = parseFloat(precoMax?.value) || Infinity;
    const qMin = parseInt(qtdMin?.value) || 0;
    const qMax = parseInt(qtdMax?.value) || Infinity;

    linhas.forEach(tr => {
        const id = tr.dataset.id;
        const nome = tr.dataset.nome;
        const preco = parseFloat(tr.dataset.preco);
        const qtd = parseInt(tr.dataset.qtd);

        const matchNome = nome.includes(termo) || id.includes(termo);
        const matchPreco = preco >= pMin && preco <= pMax;
        const matchQtd = qtd >= qMin && qtd <= qMax;

        tr.style.display = (matchNome && matchPreco && matchQtd) ? "" : "none";
    });
}

// Escuta os campos
[filtroNome, precoMin, precoMax, qtdMin, qtdMax].forEach(el => {
    el?.addEventListener("input", aplicarFiltros);
});

// Botão limpar filtros extras
btnLimpar.addEventListener("click", () => {
    precoMin.value = "";
    precoMax.value = "";
    qtdMin.value = "";
    qtdMax.value = "";
    aplicarFiltros();
});
</script>
{% endblock %}
{% endblock %}
