{% extends 'loja/barra_lateral.html' %}
{% block title %}Ajuste Manual de Estoque{% endblock %}

{% block content %}
<h2 class="fw-semibold mt-4 mb-3">Ajuste Manual de Estoque</h2>

<form method="post" action="{% url 'ajuste_estoque' %}" id="form-lote">
  {% csrf_token %}

  <!-- Toolbar: filtro + modo global + botão salvar -->
  <div class="row g-2 align-items-center mb-3">
    <div class="col-md-4">
      <input type="text" id="filtro" class="form-control" placeholder="Pesquisar por ID ou nome...">
    </div>

    <div class="col-md-5 d-flex align-items-center gap-3">
      <div class="btn-group" role="group" aria-label="Modo de operação">
        <input type="radio" class="btn-check" name="acao_global" id="modoEntrada" value="entrada" autocomplete="off" checked>
        <label class="btn btn-outline-success" for="modoEntrada">Entrada</label>

        <input type="radio" class="btn-check" name="acao_global" id="modoSaida" value="saida" autocomplete="off">
        <label class="btn btn-outline-danger" for="modoSaida">Saída</label>
      </div>
    </div>

    <div class="col-md-3 text-md-end">
      <button type="submit" class="btn btn-primary" id="btn-salvar" disabled>
        Salvar movimentações
      </button>
    </div>
  </div>

  <!-- Tabela de produtos -->
    <!-- Tabela de produtos -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped align-middle text-center">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Produto</th>
              <th>Estoque Atual</th>
              <th>Quantidade</th>
              <th>Observação (opcional)</th>
            </tr>
          </thead>
          <tbody id="tabela-produtos">
            {% for p in produtos %}
            <tr data-busca="{{ p.id }} {{ p.nome|lower }}">
              <td>{{ p.id }}</td>
              <td>{{ p.nome }}</td>
              <td>{{ p.quantidade }}</td>
              <td>
                <input
                  type="number"
                  class="form-control qtd"
                  name="qtd_{{ p.id }}"
                  min="0" step="1"
                  inputmode="numeric"
                  placeholder="0">
              </td>
              <td>
                <input
                  type="text"
                  class="form-control obs"
                  name="obs_{{ p.id }}"
                  placeholder="Motivo/observação (opcional)">
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted">Nenhum produto encontrado.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</form>

<!-- ===========================
     MODAL DE CONFIRMAÇÃO
     =========================== -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalLabel">Confirmar movimentações</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <p>
          Você está prestes a aplicar <strong><span id="confirm-qtd-itens">0</span></strong> movimentação(ões) no modo
          <strong><span id="confirm-modo">Entrada</span></strong>.
        </p>
        <p class="text-muted mb-0">
          Deseja continuar?
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btn-confirmar-modal">Confirmar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  /* Destaque visual conforme o modo */
  .modo-entrada .qtd:focus { box-shadow: 0 0 0 .25rem rgba(25,135,84,.25); }
  .modo-saida   .qtd:focus { box-shadow: 0 0 0 .25rem rgba(220,53,69,.25); }
</style>
{% endblock %}

{% block extra_js %}
<script>
  // -----------------------------
  // Filtro por ID OU nome
  // -----------------------------
  const filtro = document.getElementById('filtro');
  const linhas = document.querySelectorAll('#tabela-produtos tr[data-busca]');

  filtro?.addEventListener('input', () => {
    const q = filtro.value.trim().toLowerCase();
    linhas.forEach(tr => {
      const termo = tr.dataset.busca; // Ex.: "12 teclado mecânico"
      tr.style.display = termo.includes(q) ? '' : 'none';
    });
  });

  // -----------------------------
  // Habilitar botão "Salvar"
  // -----------------------------
  const form = document.getElementById('form-lote');
  const btnSalvar = document.getElementById('btn-salvar');
  const qtdInputs = form.querySelectorAll('input.qtd');

  const atualizarBotao = () => {
    let habilitar = false;
    qtdInputs.forEach(i => {
      if (i.value && Number(i.value) > 0) habilitar = true;
    });
    btnSalvar.disabled = !habilitar;
  };
  qtdInputs.forEach(i => i.addEventListener('input', atualizarBotao));
  atualizarBotao();

  // -----------------------------
  // Feedback visual do modo (Entrada/Saída)
  // -----------------------------
  const bodyContent = document.querySelector('body');
  const radios = form.querySelectorAll('input[name="acao_global"]');
  const aplicarClasseModo = () => {
    const modo = form.querySelector('input[name="acao_global"]:checked')?.value;
    bodyContent.classList.toggle('modo-entrada', modo === 'entrada');
    bodyContent.classList.toggle('modo-saida',   modo === 'saida');
  };
  radios.forEach(r => r.addEventListener('change', aplicarClasseModo));
  aplicarClasseModo();

  // -----------------------------
  // Confirmação antes de enviar (corrigido)
  // -----------------------------
  const modalEl = document.getElementById('confirmModal');
  const btnConfirmarModal = document.getElementById('btn-confirmar-modal');
  const spanQtd = document.getElementById('confirm-qtd-itens');
  const spanModo = document.getElementById('confirm-modo');

  let bsModal = null;
  let allowSubmit = false; // guard: só permite enviar após confirmar

  function getResumoMovimentacoes() {
    // conta quantos itens têm quantidade > 0
    let count = 0;
    qtdInputs.forEach(i => { if (i.value && Number(i.value) > 0) count++; });

    const modoVal = form.querySelector('input[name="acao_global"]:checked')?.value || 'entrada';
    const modoTxt = (modoVal === 'saida') ? 'Saída' : 'Entrada';
    return { count, modoTxt };
  }

  form.addEventListener('submit', (e) => {
    if (allowSubmit) {
      // já confirmado -> deixa enviar e reseta flag
      allowSubmit = false;
      return;
    }

    // 1ª tentativa: bloqueia envio e abre modal
    e.preventDefault();

    const { count, modoTxt } = getResumoMovimentacoes();
    if (count === 0) {
      alert('Informe ao menos uma quantidade para movimentar.');
      return;
    }

    spanQtd.textContent = count;
    spanModo.textContent = modoTxt;

    bsModal = bsModal || new bootstrap.Modal(modalEl);
    bsModal.show();
  });

  btnConfirmarModal.addEventListener('click', () => {
    // libera o envio e dispara um submit "de verdade"
    allowSubmit = true;
    bsModal?.hide();

    // requestSubmit aciona validações nativas e o listener acima,
    // mas agora allowSubmit=true deixa passar.
    if (form.requestSubmit) {
      form.requestSubmit();
    } else {
      form.submit(); // fallback
    }
  });
</script>
{% endblock %}
