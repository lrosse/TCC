{% extends "loja/barra_lateral.html" %}
{% block title %}Gest칚o Financeira{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <h2 class="fw-semibold mb-4">Gest칚o Financeira</h2>

  <!-- 游댒 Avisos Inteligentes -->
  {% if lucro_liquido < 0 %}
  <div class="alert alert-danger d-flex align-items-center" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    Gastos do m칡s est칚o acima da receita! Revise suas despesas.
  </div>
  {% endif %}

  <!-- Abas -->
  <ul class="nav nav-tabs mb-4" id="financeiroTabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#resumo">Resumo Geral</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#produtos">Produtos</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#pedidos">Pedidos</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#despesas">Despesas</button></li>
  </ul>

  <div class="tab-content">

    <!-- 游댳 RESUMO GERAL -->
    <div class="tab-pane fade show active" id="resumo">
      <div class="row g-4 mb-4">
        <!-- Receita -->
        <div class="col-md-3">
          <div class="card text-center shadow-sm border-0">
            <div class="card-body">
              <h6 class="text-muted">Receita Total</h6>
              <p class="fs-5 fw-bold text-success">R$ {{ receita_total|floatformat:2 }}</p>
            </div>
          </div>
        </div>
        <!-- Custo -->
        <div class="col-md-3">
          <div class="card text-center shadow-sm border-0">
            <div class="card-body">
              <h6 class="text-muted">Custo Total</h6>
              <p class="fs-5 fw-bold text-danger">R$ {{ custo_total|floatformat:2 }}</p>
            </div>
          </div>
        </div>
        <!-- Despesas -->
        <div class="col-md-3">
          <div class="card text-center shadow-sm border-0">
            <div class="card-body">
              <h6 class="text-muted">Despesas Fixas</h6>
              <p class="fs-5 fw-bold text-warning">R$ {{ despesas_fixas|floatformat:2 }}</p>
            </div>
          </div>
        </div>
        <!-- Lucro -->
        <div class="col-md-3">
          <div class="card text-center shadow-sm border-0">
            <div class="card-body">
              <h6 class="text-muted">Lucro L칤quido</h6>
              <p class="fs-5 fw-bold {% if lucro_liquido < 0 %}text-danger{% else %}text-primary{% endif %}">
                R$ {{ lucro_liquido|floatformat:2 }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Gr치ficos -->
      <div class="row g-4 mb-4">
        <!-- Receitas vs Despesas -->
        <div class="col-md-4">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <h6 class="fw-semibold mb-2">Receitas vs Despesas</h6>
              <canvas id="graficoReceitasDespesas"></canvas>
            </div>
          </div>
        </div>
        <!-- Lucro L칤quido -->
        <div class="col-md-4">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <h6 class="fw-semibold mb-2">Lucro L칤quido</h6>
              <canvas id="graficoLucro"></canvas>
            </div>
          </div>
        </div>
        <!-- Despesas Fixas vs Vari치veis -->
        <div class="col-md-4">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <h6 class="fw-semibold mb-2">Despesas Fixas vs Vari치veis</h6>
              <canvas id="graficoDespesas"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 游댳 PRODUTOS -->
    <div class="tab-pane fade" id="produtos">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="fw-semibold mb-3">Margens de Produtos</h5>
          <div class="mb-3">
            <input type="text" id="buscaProdutos" class="form-control" placeholder="Buscar produto...">
          </div>
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>Produto</th>
                <th>Custo</th>
                <th>Pre칞o Venda</th>
                <th>Margem (%)</th>
                <th>Lucro Unit치rio</th>
              </tr>
            </thead>
            <tbody id="tabelaProdutos">
              {% for p in produtos_data %}
              <tr>
                <td>{{ p.nome }}</td>
                <td>R$ {{ p.custo|floatformat:2 }}</td>
                <td>R$ {{ p.preco|floatformat:2 }}</td>
                <td>{{ p.margem }}%</td>
                <td>R$ {{ p.lucro_unitario|floatformat:2 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="row g-4 mt-3">
        <div class="col-md-6">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <h6 class="fw-semibold mb-2">Top 5 Produtos Mais Rent치veis</h6>
              <canvas id="graficoTopMais"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <h6 class="fw-semibold mb-2">Top 5 Produtos Menos Rent치veis</h6>
              <canvas id="graficoTopMenos"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 游댳 PEDIDOS -->
    <div class="tab-pane fade" id="pedidos">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-semibold">Lucro por Pedido</h5>
            <input type="text" id="buscaPedidos" class="form-control w-25" placeholder="Buscar pedido...">
          </div>
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>N췈 Pedido</th>
                <th>Cliente</th>
                <th>Data</th>
                <th>Receita</th>
                <th>Custo</th>
                <th>Lucro</th>
              </tr>
            </thead>
            <tbody id="tabelaPedidos">
              {% for p in pedidos_data %}
              <tr>
                <td>#{{ p.numero }}</td>
                <td>{{ p.cliente }}</td>
                <td>{{ p.data }}</td>
                <td>R$ {{ p.receita|floatformat:2 }}</td>
                <td>R$ {{ p.custo|floatformat:2 }}</td>
                <td class="{% if p.lucro < 0 %}text-danger{% else %}text-success{% endif %}">
                  R$ {{ p.lucro|floatformat:2 }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 游댳 DESPESAS -->
    <!-- 游댳 DESPESAS -->
<div class="tab-pane fade" id="despesas">
  <div class="row g-4 mb-4">

    <!-- Formul치rio -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="fw-semibold mb-3">Adicionar Despesa</h5>
          <form method="POST" action="{% url 'financeiro' %}">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">Categoria</label>
              <input type="text" name="categoria" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Tipo</label>
              <select name="tipo" class="form-select" required>
                <option value="Fixo">Fixo</option>
                <option value="Vari치vel">Vari치vel</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Valor (R$)</label>
              <input type="number" step="0.01" name="valor" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Data</label>
              <input type="date" name="data" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Descri칞칚o</label>
              <textarea name="descricao" class="form-control"></textarea>
            </div>
            <button class="btn btn-danger" type="submit">
              <i class="bi bi-plus-circle"></i> Adicionar
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Lista -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="fw-semibold mb-3">Despesas Registradas</h5>
          <table class="table table-striped align-middle">
            <thead>
                <tr>
                <th>Data</th>
                <th>Categoria</th>
                <th>Tipo</th>
                <th>Valor</th>
                <th>A칞칫es</th>
                </tr>
            </thead>
            <tbody>
                {% for d in despesas %}
                <tr>
                <td>{{ d.data|date:"d/m/Y" }}</td>
                <td>{{ d.categoria }}</td>
                <td>{{ d.tipo }}</td>
                <td>R$ {{ d.valor|floatformat:2 }}</td>
                <td>
                    <a href="{% url 'editar_despesa' d.id %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil"></i>
                    </a>
                    <a href="{% url 'excluir_despesa' d.id %}" class="btn btn-sm btn-outline-danger">
                    <i class="bi bi-trash"></i>
                    </a>
                </td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center text-muted">Nenhuma despesa registrada</td></tr>
                {% endfor %}
            </tbody>
            </table>
        </div>
      </div>
    </div>

  </div>
</div>

  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const meses = {{ meses_labels_json|safe }};
const receitas = {{ receitas_mes_json|safe }};
const despesas = {{ despesas_mes_json|safe }};
const lucro = {{ lucro_mes_json|safe }};
const fixas = {{ fixas_valor }};
const variaveis = {{ variaveis_valor }};

// 游늵 Receitas vs Despesas
new Chart(document.getElementById('graficoReceitasDespesas'), {
  type: 'bar',
  data: { labels: meses, datasets: [
    { label: 'Receitas', data: receitas, backgroundColor: '#198754' },
    { label: 'Despesas', data: despesas, backgroundColor: '#dc3545' }
  ]}
});

// 游늵 Lucro l칤quido
new Chart(document.getElementById('graficoLucro'), {
  type: 'line',
  data: { labels: meses, datasets: [
    { label: 'Lucro L칤quido', data: lucro, borderColor: '#0d6efd', fill: true }
  ]}
});

// 游늵 Despesas fixas vs vari치veis
new Chart(document.getElementById('graficoDespesas'), {
  type: 'doughnut',
  data: { labels: ['Fixas','Vari치veis'], datasets: [
    { data: [fixas, variaveis], backgroundColor: ['#ffc107','#0dcaf0'] }
  ]}
});

// 游늵 Top Produtos
new Chart(document.getElementById('graficoTopMais'), {
  type: 'bar',
  data: { labels: {{ top_mais_labels|safe }}, datasets: [
    { label: 'Lucro', data: {{ top_mais_json|safe }}, backgroundColor: '#20c997' }
  ]}
});
new Chart(document.getElementById('graficoTopMenos'), {
  type: 'bar',
  data: { labels: {{ top_menos_labels|safe }}, datasets: [
    { label: 'Lucro', data: {{ top_menos_json|safe }}, backgroundColor: '#fd7e14' }
  ]}
});

// 游댌 Filtros r치pidos
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("buscaProdutos").addEventListener("input", function() {
    const termo = this.value.toLowerCase();
    document.getElementById("tabelaProdutos").querySelectorAll("tr").forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(termo) ? "" : "none";
    });
  });
  document.getElementById("buscaPedidos").addEventListener("input", function() {
    const termo = this.value.toLowerCase();
    document.getElementById("tabelaPedidos").querySelectorAll("tr").forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(termo) ? "" : "none";
    });
  });
});
</script>
{% endblock %}
