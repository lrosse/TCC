{% extends "loja/barra_lateral.html" %}
{% block title %}Gestão de Estoque{% endblock %}

{% block content %}
<style>
  thead th {
    vertical-align: middle;
  }

  .data-cell {
    white-space: nowrap;
  }

  .card-estatistica {
    border: none;
    border-radius: 12px;
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .card-estatistica:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
  }

  .card-estatistica .icon-wrapper {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
  }

  .icon-wrapper.primary {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  }

  .icon-wrapper.warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  }

  .icon-wrapper.success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  }

  /* Responsividade */
  @media (max-width: 992px) {
    .table thead th {
      font-size: 0.65rem;
      padding: 0.75rem 0.5rem;
    }
    
    .table tbody td {
      font-size: 0.75rem;
      padding: 0.75rem 0.5rem;
    }

    .card-estatistica .icon-wrapper {
      width: 48px;
      height: 48px;
      font-size: 1.5rem;
    }
  }

  @media (max-width: 768px) {
    .container-fluid {
      padding-left: 1rem !important;
      padding-right: 1rem !important;
    }

    h2 {
      font-size: 1.25rem !important;
    }

    .card-estatistica h6 {
      font-size: 0.875rem;
    }

    .card-estatistica .fs-4 {
      font-size: 1.25rem !important;
    }
  }

  @media (max-width: 576px) {
    .table-responsive {
      font-size: 0.7rem;
    }

    .data-cell {
      font-size: 0.65rem;
    }
  }
</style>

<div class="container-fluid px-4" style="background-color: #f8fafc; min-height: 100vh; padding-top: 2rem;">
  <!-- Cabeçalho -->
  <div class="d-flex justify-content-between align-items-center mb-4 p-4 bg-white rounded shadow-sm">
    <h2 class="fw-bold mb-0" style="color: #1e293b; letter-spacing: -0.025em;">Gestão de Estoque</h2>
  </div>

  <!-- Cards de Estatísticas -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-sm-6 col-lg-4">
      <div class="card card-estatistica shadow-sm">
        <div class="card-body p-4">
          <div class="d-flex align-items-center gap-3">
            <div class="icon-wrapper primary">
              <i class="bi bi-box-seam text-white"></i>
            </div>
            <div>
              <h6 class="mb-1" style="color: #64748b; font-size: 0.875rem; font-weight: 500;">Total de Produtos</h6>
              <p class="fs-4 fw-bold mb-0" style="color: #1e293b;">{{ total_produtos }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-4">
      <div class="card card-estatistica shadow-sm">
        <div class="card-body p-4">
          <div class="d-flex align-items-center gap-3">
            <div class="icon-wrapper warning">
              <i class="bi bi-exclamation-triangle text-white"></i>
            </div>
            <div>
              <h6 class="mb-1" style="color: #64748b; font-size: 0.875rem; font-weight: 500;">Estoque Baixo</h6>
              <p class="fs-4 fw-bold mb-0" style="color: #1e293b;">{{ produtos_baixo_estoque }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-4">
      <div class="card card-estatistica shadow-sm">
        <div class="card-body p-4">
          <div class="d-flex align-items-center gap-3">
            <div class="icon-wrapper success">
              <i class="bi bi-clock-history text-white"></i>
            </div>
            <div>
              <h6 class="mb-1" style="color: #64748b; font-size: 0.875rem; font-weight: 500;">Última Movimentação</h6>
              <p class="mb-0" style="color: #1e293b; font-weight: 600; font-size: 0.9rem;">{{ ultima_movimentacao }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Barra de busca e filtros -->
  <div class="mb-3 p-3 bg-white rounded shadow-sm">
    <label for="busca-produto" class="form-label fw-semibold" style="color: #475569; font-size: 0.875rem;">Pesquisar produtos em estoque</label>

    <form id="formBusca" method="GET">
      <div class="row g-2">
        <div class="col-md-6">
          <input type="text" id="busca-produto" name="q" class="form-control form-control-sm" placeholder="Digite o nome do produto..." value="{{ request.GET.q }}" style="border: 2px solid #e2e8f0; border-radius: 8px; background: #f8fafc; font-size: 0.8125rem;" />
        </div>

        <div class="col-md-4">
          <select name="filtro" class="form-select form-select-sm" style="border: 2px solid #e2e8f0; border-radius: 8px; background: #ffffff; font-size: 0.8125rem;">
            <option value="">Todos os níveis</option>
            <option value="baixo" {% if request.GET.filtro == "baixo" %}selected{% endif %}>Abaixo do mínimo</option>
            <option value="medio" {% if request.GET.filtro == "medio" %}selected{% endif %}>Entre mínimo e ideal</option>
            <option value="alto" {% if request.GET.filtro == "alto" %}selected{% endif %}>Acima do ideal</option>
          </select>
        </div>

        <div class="col-md-2 text-end" id="btnArea">
          <button type="button" id="btnDefinir" class="btn btn-outline-secondary btn-sm w-100" style="border: 2px solid #e2e8f0; border-radius: 8px; font-weight: 500;">
            <i class="bi bi-sliders me-1"></i> Definir Limites
          </button>
        </div>
      </div>
    </form>

    <!-- Legenda -->
    <div class="d-flex justify-content-end flex-wrap gap-3 mt-3">
      <small class="d-flex align-items-center gap-2">
        <span style="display: inline-block; width: 16px; height: 16px; background-color: #dc3545; border-radius: 4px;"></span>
        <span style="color: #64748b;">Abaixo do mínimo</span>
      </small>
      <small class="d-flex align-items-center gap-2">
        <span style="display: inline-block; width: 16px; height: 16px; background-color: #198754; border-radius: 4px;"></span>
        <span style="color: #64748b;">Bom (entre mínimo e ideal)</span>
      </small>
      <small class="d-flex align-items-center gap-2">
        <span style="display: inline-block; width: 16px; height: 16px; background-color: #ffc107; border-radius: 4px;"></span>
        <span style="color: #64748b;">Acima do ideal</span>
      </small>
    </div>
  </div>

  <!-- Tabela -->
  <div class="card shadow-sm" style="border: none; border-radius: 12px; overflow: hidden;">
    <div class="card-body p-0">
      <div class="table-responsive">
        <form id="formLimites" method="POST">
          {% csrf_token %}
          <table class="table align-middle mb-0" id="tabelaEstoque">
            <thead style="background: #f8fafc;">
              <tr id="tabelaHead">
                <th style="color: #64748b; font-weight: 500; font-size: 0.75rem; padding: 1rem 1.25rem;">Produto</th>
                <th style="color: #64748b; font-weight: 500; font-size: 0.75rem;">Quantidade Atual</th>
                <th style="color: #64748b; font-weight: 500; font-size: 0.75rem; min-width: 180px;">Estoque (%)</th>
                <th style="color: #64748b; font-weight: 500; font-size: 0.75rem;">Última atualização</th>
              </tr>
            </thead>
            <tbody>
              {% for p in tabela_produtos %}
              <tr data-produto="{{ p.id }}" data-minimo="{{ p.minimo }}" data-ideal="{{ p.ideal }}" style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 1rem 1.25rem;">
                  <span style="font-weight: 600; color: #1e293b; font-size: 0.875rem;">{{ p.nome }}</span>
                </td>
                <td>
                  <span class="badge" style="background-color: #e0e7ff; color: #3730a3; padding: 4px 10px; font-size: 0.75rem; font-weight: 600; border-radius: 6px;">
                    {{ p.quantidade }} unid.
                  </span>
                </td>
                <td style="width: 300px;">
                  <div class="progress" style="height: 22px; border-radius: 8px; background-color: #f1f5f9;">
                    <div class="progress-bar {{ p.cor }}" role="progressbar" style="width: {{ p.percentual }}%; font-size: 0.75rem; font-weight: 600; border-radius: 8px;">
                      {{ p.percentual }}%
                    </div>
                  </div>
                </td>
                <td class="data-cell">{{ p.ultima_atualizacao|date:"d/m/Y H:i" }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="text-center py-5" style="color: #64748b;">
                  <i class="bi bi-inbox display-1 mb-3 d-block"></i>
                  <p class="mb-1">Nenhum produto em estoque.</p>
                  <small>Os produtos cadastrados aparecerão aqui.</small>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055">
  <div id="toastMsg" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">Limites atualizados com sucesso!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const formBusca = document.getElementById("formBusca");
  const tabelaBody = document.querySelector("#tabelaEstoque tbody");
  const inputBusca = formBusca.querySelector("input[name='q']");
  const selectFiltro = formBusca.querySelector("select[name='filtro']");

  function attachSalvar() {
    document.getElementById("btnSalvar")?.addEventListener("click", () => {
      let form = document.getElementById("formLimites");
      let formData = new FormData(form);

      fetch("{% url 'gestao_estoque' %}", {
        method: "POST",
        body: formData,
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          location.reload();
        }
      });
    });
  }

  function attachCancelar() {
    document.getElementById("btnCancelar")?.addEventListener("click", () => {
      location.reload();
    });
  }

  function attachDefinir() {
    document.getElementById("btnDefinir")?.addEventListener("click", (e) => {
      e.preventDefault();
      const tabelaHead = document.getElementById("tabelaHead");
      const btnArea = document.getElementById("btnArea");

      tabelaHead.innerHTML = `
        <th style="color: #64748b; font-weight: 500; font-size: 0.75rem; padding: 1rem 1.25rem;">Produto</th>
        <th style="color: #64748b; font-weight: 500; font-size: 0.75rem;">Quantidade Atual</th>
        <th style="color: #64748b; font-weight: 500; font-size: 0.75rem;">Mínimo (vermelho)</th>
        <th style="color: #64748b; font-weight: 500; font-size: 0.75rem;">Ideal (verde a partir de)</th>
      `;

      document.querySelectorAll("#tabelaEstoque tbody tr").forEach(row => {
        const id = row.getAttribute("data-produto");
        const minimo = row.getAttribute("data-minimo");
        const ideal = row.getAttribute("data-ideal");

        row.querySelectorAll("td").forEach((cell, index) => {
          if (index === 2) {
            cell.innerHTML = `<input type="number" name="minimo_${id}" value="${minimo}" class="form-control form-control-sm" style="border: 2px solid #e2e8f0; border-radius: 8px;">`;
          }
          if (index === 3) {
            cell.innerHTML = `<input type="number" name="ideal_${id}" value="${ideal}" class="form-control form-control-sm" style="border: 2px solid #e2e8f0; border-radius: 8px;">`;
          }
        });
      });

      btnArea.innerHTML = `
        <button type="button" id="btnSalvar" class="btn btn-success btn-sm" style="background: #10b981; border: none; border-radius: 8px; font-weight: 600;">
          <i class="bi bi-save me-1"></i> Salvar
        </button>
        <button type="button" id="btnCancelar" class="btn btn-outline-secondary btn-sm ms-2" style="border: 2px solid #e2e8f0; border-radius: 8px; font-weight: 500;">
          Cancelar
        </button>
      `;

      attachSalvar();
      attachCancelar();
    });
  }

  function rebindEvents() {
    attachDefinir();
    attachSalvar();
    attachCancelar();
  }

  // Atualiza tabela em tempo real
  function atualizarTabela() {
    let formData = new FormData(formBusca);
    let params = new URLSearchParams(formData).toString();

    fetch("{% url 'gestao_estoque' %}?" + params, {
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(res => res.json())
    .then(data => {
      tabelaBody.innerHTML = "";

      if (data.produtos.length === 0) {
        tabelaBody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center py-5" style="color: #64748b;">
              <i class="bi bi-inbox display-1 mb-3 d-block"></i>
              <p class="mb-1">Nenhum produto encontrado.</p>
              <small>Tente ajustar os filtros.</small>
            </td>
          </tr>
        `;
      } else {
        data.produtos.forEach(p => {
          let row = `
            <tr data-produto="${p.id}" data-minimo="${p.minimo}" data-ideal="${p.ideal}" style="border-bottom: 1px solid #e2e8f0;">
              <td style="padding: 1rem 1.25rem;">
                <span style="font-weight: 600; color: #1e293b; font-size: 0.875rem;">${p.nome}</span>
              </td>
              <td>
                <span class="badge" style="background-color: #e0e7ff; color: #3730a3; padding: 4px 10px; font-size: 0.75rem; font-weight: 600; border-radius: 6px;">
                  ${p.quantidade} unid.
                </span>
              </td>
              <td style="width: 300px;">
                <div class="progress" style="height: 22px; border-radius: 8px; background-color: #f1f5f9;">
                  <div class="progress-bar ${p.cor}" role="progressbar" style="width: ${p.percentual}%; font-size: 0.75rem; font-weight: 600; border-radius: 8px;">
                    ${p.percentual}%
                  </div>
                </div>
              </td>
              <td class="data-cell">${p.ultima_atualizacao}</td>
            </tr>
          `;
          tabelaBody.insertAdjacentHTML("beforeend", row);
        });
      }

      rebindEvents();
    });
  }

  // Busca em tempo real
  inputBusca.addEventListener("input", atualizarTabela);

  // Filtro em tempo real
  selectFiltro.addEventListener("change", atualizarTabela);

  // Carregar tabela inicial
  atualizarTabela();

  rebindEvents();
});
</script>
{% endblock %}
{% endblock %}