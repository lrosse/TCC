{% extends "loja/barra_lateral.html" %}
{% block title %}Gestão Financeira - Histórico de Custo{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <h2 class="fw-semibold mb-3">Histórico de Custo</h2>

  <!-- Abas com preservação de querystring -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item">
      <a class="nav-link {% if request.resolver_match.url_name == 'financeiro_resumo' %}active{% endif %}"
         href="{% url 'financeiro_resumo' %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}">
        Resumo Geral
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if request.resolver_match.url_name == 'financeiro_produtos' %}active{% endif %}"
         href="{% url 'financeiro_produtos' %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}">
        Produtos
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if request.resolver_match.url_name == 'financeiro_pedidos' %}active{% endif %}"
         href="{% url 'financeiro_pedidos' %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}">
        Pedidos
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link active"
         href="{% url 'historico_custo' %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}">
        Histórico de Custo
      </a>
    </li>
  </ul>

  <!-- Form de filtro por datas (GET) já preenchido -->
  <form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-auto">
      <label for="data_inicio" class="form-label mb-0">Início</label>
      <input type="date" id="data_inicio" name="data_inicio" class="form-control form-control-sm"
             value="{{ data_inicio }}">
    </div>
    <div class="col-auto">
      <label for="data_fim" class="form-label mb-0">Fim</label>
      <input type="date" id="data_fim" name="data_fim" class="form-control form-control-sm"
             value="{{ data_fim }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-sm btn-primary"><i class="bi bi-funnel"></i> Aplicar</button>
    </div>
    {% if data_inicio or data_fim %}
    <div class="col-auto">
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'historico_custo' %}">Limpar</a>
    </div>
    {% endif %}
  </form>

  {% if data_inicio or data_fim %}
    <div class="alert alert-light border py-2">
      <i class="bi bi-funnel me-2"></i>
      Filtro:
      {% if data_inicio %}de <strong>{{ data_inicio }}</strong>{% endif %}
      {% if data_fim %} até <strong>{{ data_fim }}</strong>{% endif %}
    </div>
  {% endif %}

  <div class="card shadow-sm border-0">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead class="table-light">
            <tr>
              <th>Data</th>
              <th>Produto</th>
              <th>Custo Antigo</th>
              <th>Custo Novo</th>
              <th>Responsável</th>
              <th>Descrição</th>
            </tr>
          </thead>
          <tbody>
            {% for h in historicos %}
            <tr>
              <td>{{ h.data|date:"d/m/Y H:i" }}</td>
              <td>{{ h.produto.nome }}</td>
              <td>R$ {{ h.custo_antigo|floatformat:2 }}</td>
              <td>R$ {{ h.custo_novo|floatformat:2 }}</td>
              <td>{{ h.usuario.username }}</td>
              <td class="text-muted">{{ h.descricao|default:"-" }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted">Nenhum histórico encontrado</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Atalho de volta para Pedidos mantendo filtros -->
      <div class="mt-3">
        <a class="btn btn-outline-secondary btn-sm"
           href="{% url 'financeiro_pedidos' %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}">
           Voltar para Pedidos
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}
