{% extends 'loja/barra_lateral.html' %}
{% load static %}

{% block title %}Relatório Avançado{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <!-- Título -->
  <h2 class="fw-semibold mb-4">
    <i class="bi bi-bar-chart"></i> Relatórios Avançados
  </h2>

  <!-- Accordion de filtros -->
  <div class="accordion" id="accordionFiltros">

    <!-- =====================================================
         PRODUTOS
    ====================================================== -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingProdutos">
        <button class="accordion-button {% if tipo != 'produtos' %}collapsed{% endif %}" 
                type="button" data-bs-toggle="collapse" data-bs-target="#collapseProdutos"
                aria-expanded="{% if tipo == 'produtos' %}true{% else %}false{% endif %}">
          <i class="bi bi-box-seam me-2 text-primary"></i> Filtros de Produtos
        </button>
      </h2>
      <div id="collapseProdutos" class="accordion-collapse collapse {% if tipo == 'produtos' %}show{% endif %}">
        <div class="accordion-body">
          <form method="get" class="row g-3 mb-3">
            <input type="hidden" name="tipo" value="produtos">

            <!-- Nome -->
            <div class="col-md-4">
              <label class="form-label">Nome</label>
              <input type="text" name="nome" class="form-control" value="{{ request.GET.nome }}">
            </div>

            <!-- Preço -->
            <div class="col-md-2">
              <label class="form-label">Preço Mínimo</label>
              <input type="number" step="0.01" name="preco_min" class="form-control" value="{{ request.GET.preco_min }}">
            </div>
            <div class="col-md-2">
              <label class="form-label">Preço Máximo</label>
              <input type="number" step="0.01" name="preco_max" class="form-control" value="{{ request.GET.preco_max }}">
            </div>

            <!-- Quantidade -->
            <div class="col-md-2">
              <label class="form-label">Qtd. Mínima</label>
              <input type="number" name="qtd_min" class="form-control" value="{{ request.GET.qtd_min }}">
            </div>
            <div class="col-md-2">
              <label class="form-label">Qtd. Máxima</label>
              <input type="number" name="qtd_max" class="form-control" value="{{ request.GET.qtd_max }}">
            </div>

            <!-- Status de Estoque -->
            <div class="col-md-3">
              <label class="form-label">Status de Estoque</label>
              <select name="status_estoque" class="form-select">
                <option value="">Todos</option>
                <option value="minimo" {% if request.GET.status_estoque == "minimo" %}selected{% endif %}>Abaixo do mínimo</option>
                <option value="ideal" {% if request.GET.status_estoque == "ideal" %}selected{% endif %}>Abaixo do ideal</option>
                <option value="bom" {% if request.GET.status_estoque == "bom" %}selected{% endif %}>Bom</option>
              </select>
            </div>

            <!-- Ordenação -->
            <div class="col-md-3">
              <label class="form-label">Ordenar por</label>
              <select name="ordenar_por" class="form-select">
                <option value="">Padrão</option>
                <option value="nome" {% if request.GET.ordenar_por == "nome" %}selected{% endif %}>Nome</option>
                <option value="preco" {% if request.GET.ordenar_por == "preco" %}selected{% endif %}>Preço</option>
                <option value="quantidade" {% if request.GET.ordenar_por == "quantidade" %}selected{% endif %}>Quantidade</option>
                <option value="recente" {% if request.GET.ordenar_por == "recente" %}selected{% endif %}>Mais recente</option>
              </select>
            </div>

            <!-- Botões -->
            <div class="col-12 d-flex justify-content-end">
              <a href="{% url 'relatorio_avancado' %}" class="btn btn-secondary me-2">
                <i class="bi bi-x-circle"></i> Resetar
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-arrow-repeat"></i> Atualizar
              </button>
            </div>
          </form>

          <!-- Tabela Produtos -->
          {% if tipo == "produtos" %}
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead class="table-dark">
                <tr>
                  <th>Nome</th>
                  <th>Preço</th>
                  <th>Quantidade</th>
                  <th>Estoque</th>
                </tr>
              </thead>
              <tbody>
                {% for p in produtos %}
                <tr>
                  <td>{{ p.nome }}</td>
                  <td>R$ {{ p.preco }}</td>
                  <td>{{ p.quantidade }}</td>
                  <td>
                    {% if p.quantidade <= p.minimo_estoque %}
                      <span class="badge bg-danger">Abaixo do mínimo</span>
                    {% elif p.quantidade <= p.ideal_estoque %}
                      <span class="badge bg-warning text-dark">Abaixo do ideal</span>
                    {% else %}
                      <span class="badge bg-success">Estoque bom</span>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted">Nenhum produto encontrado.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- =====================================================
         PEDIDOS
    ====================================================== -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingPedidos">
        <button class="accordion-button {% if tipo != 'pedidos' %}collapsed{% endif %}" 
                type="button" data-bs-toggle="collapse" data-bs-target="#collapsePedidos">
          <i class="bi bi-receipt me-2 text-success"></i> Filtros de Pedidos
        </button>
      </h2>
      <div id="collapsePedidos" class="accordion-collapse collapse {% if tipo == 'pedidos' %}show{% endif %}">
        <div class="accordion-body">
          <form method="get" class="row g-3 mb-3">
            <input type="hidden" name="tipo" value="pedidos">

            <div class="col-md-3">
              <label class="form-label">Número</label>
              <input type="text" name="numero" class="form-control" value="{{ request.GET.numero }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Cliente</label>
              <input type="text" name="cliente" class="form-control" value="{{ request.GET.cliente }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Status</label>
              <select name="status" class="form-select">
                <option value="">Todos</option>
                <option value="Pendente" {% if request.GET.status == "Pendente" %}selected{% endif %}>Pendente</option>
                <option value="Pago" {% if request.GET.status == "Pago" %}selected{% endif %}>Pago</option>
                <option value="Cancelado" {% if request.GET.status == "Cancelado" %}selected{% endif %}>Cancelado</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Valor mínimo</label>
              <input type="number" step="0.01" name="valor_min" class="form-control" value="{{ request.GET.valor_min }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Valor máximo</label>
              <input type="number" step="0.01" name="valor_max" class="form-control" value="{{ request.GET.valor_max }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Data início</label>
              <input type="date" name="data_inicio" class="form-control" value="{{ request.GET.data_inicio }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Data fim</label>
              <input type="date" name="data_fim" class="form-control" value="{{ request.GET.data_fim }}">
            </div>

            <div class="col-12 d-flex justify-content-end">
              <a href="{% url 'relatorio_avancado' %}" class="btn btn-secondary me-2">Resetar</a>
              <button type="submit" class="btn btn-primary">Atualizar</button>
            </div>
          </form>

          {% if tipo == "pedidos" %}
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead class="table-dark">
                <tr>
                  <th>Número</th>
                  <th>Cliente</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th>Data</th>
                </tr>
              </thead>
              <tbody>
                {% for p in pedidos %}
                <tr>
                  <td>{{ p.numero_pedido }}</td>
                  <td>{{ p.cliente.username }}</td>
                  <td>R$ {{ p.total }}</td>
                  <td><span class="badge bg-info">{{ p.status }}</span></td>
                  <td>{{ p.data_criacao|date:"d/m/Y" }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center">Nenhum pedido encontrado.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- =====================================================
         ESTOQUE
    ====================================================== -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingEstoque">
        <button class="accordion-button {% if tipo != 'estoque' %}collapsed{% endif %}" 
                type="button" data-bs-toggle="collapse" data-bs-target="#collapseEstoque">
          <i class="bi bi-box2-heart me-2 text-warning"></i> Filtros de Estoque
        </button>
      </h2>
      <div id="collapseEstoque" class="accordion-collapse collapse {% if tipo == 'estoque' %}show{% endif %}">
        <div class="accordion-body">
          <form method="get" class="row g-3 mb-3">
            <input type="hidden" name="tipo" value="estoque">

            <div class="col-md-3">
              <label class="form-label">Produto</label>
              <input type="text" name="produto" class="form-control" value="{{ request.GET.produto }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Tipo</label>
              <select name="tipo" class="form-select">
                <option value="">Todos</option>
                <option value="entrada" {% if request.GET.tipo == "entrada" %}selected{% endif %}>Entrada</option>
                <option value="ajuste" {% if request.GET.tipo == "ajuste" %}selected{% endif %}>Ajuste</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Qtd. mínima</label>
              <input type="number" name="qtd_min" class="form-control" value="{{ request.GET.qtd_min }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Qtd. máxima</label>
              <input type="number" name="qtd_max" class="form-control" value="{{ request.GET.qtd_max }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Data início</label>
              <input type="date" name="data_inicio" class="form-control" value="{{ request.GET.data_inicio }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Data fim</label>
              <input type="date" name="data_fim" class="form-control" value="{{ request.GET.data_fim }}">
            </div>

            <div class="col-12 d-flex justify-content-end">
              <a href="{% url 'relatorio_avancado' %}" class="btn btn-secondary me-2">Resetar</a>
              <button type="submit" class="btn btn-primary">Atualizar</button>
            </div>
          </form>

          {% if tipo == "estoque" %}
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead class="table-dark">
                <tr>
                  <th>Produto</th>
                  <th>Tipo</th>
                  <th>Quantidade</th>
                  <th>Estoque final</th>
                  <th>Data</th>
                </tr>
              </thead>
              <tbody>
                {% for m in movs %}
                <tr>
                  <td>{{ m.produto.nome }}</td>
                  <td>{{ m.get_tipo_display }}</td>
                  <td>{{ m.quantidade }}</td>
                  <td>{{ m.estoque_final }}</td>
                  <td>{{ m.data|date:"d/m/Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center">Nenhuma movimentação encontrada.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- =====================================================
         FINANCEIRO
    ====================================================== -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingFinanceiro">
        <button class="accordion-button {% if tipo != 'financeiro' %}collapsed{% endif %}" 
                type="button" data-bs-toggle="collapse" data-bs-target="#collapseFinanceiro">
          <i class="bi bi-cash-coin me-2 text-danger"></i> Filtros Financeiros
        </button>
      </h2>
      <div id="collapseFinanceiro" class="accordion-collapse collapse {% if tipo == 'financeiro' %}show{% endif %}">
        <div class="accordion-body">
          <form method="get" class="row g-3 mb-3">
            <input type="hidden" name="tipo" value="financeiro">

            <div class="col-md-3">
              <label class="form-label">Categoria</label>
              <input type="text" name="categoria" class="form-control" value="{{ request.GET.categoria }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Tipo</label>
              <select name="tipo_lancamento" class="form-select">
                <option value="">Todos</option>
                <option value="receita" {% if request.GET.tipo_lancamento == "receita" %}selected{% endif %}>Receita</option>
                <option value="despesa" {% if request.GET.tipo_lancamento == "despesa" %}selected{% endif %}>Despesa</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Valor mínimo</label>
              <input type="number" step="0.01" name="valor_min" class="form-control" value="{{ request.GET.valor_min }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Valor máximo</label>
              <input type="number" step="0.01" name="valor_max" class="form-control" value="{{ request.GET.valor_max }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Data início</label>
              <input type="date" name="data_inicio" class="form-control" value="{{ request.GET.data_inicio }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Data fim</label>
              <input type="date" name="data_fim" class="form-control" value="{{ request.GET.data_fim }}">
            </div>

            <div class="col-12 d-flex justify-content-end">
              <a href="{% url 'relatorio_avancado' %}" class="btn btn-secondary me-2">Resetar</a>
              <button type="submit" class="btn btn-primary">Atualizar</button>
            </div>
          </form>

          {% if tipo == "financeiro" %}
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead class="table-dark">
                <tr>
                  <th>Categoria</th>
                  <th>Tipo</th>
                  <th>Valor</th>
                  <th>Data</th>
                </tr>
              </thead>
              <tbody>
                {% for l in lancamentos %}
                <tr>
                  <td>{{ l.categoria }}</td>
                  <td>{{ l.get_tipo_display }}</td>
                  <td>R$ {{ l.valor }}</td>
                  <td>{{ l.data|date:"d/m/Y" }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-center">Nenhum lançamento encontrado.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- =====================================================
         FEEDBACKS
    ====================================================== -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingFeedbacks">
        <button class="accordion-button {% if tipo != 'feedbacks' %}collapsed{% endif %}" 
                type="button" data-bs-toggle="collapse" data-bs-target="#collapseFeedbacks">
          <i class="bi bi-chat-dots me-2 text-info"></i> Filtros de Feedbacks
        </button>
      </h2>
      <div id="collapseFeedbacks" class="accordion-collapse collapse {% if tipo == 'feedbacks' %}show{% endif %}">
        <div class="accordion-body">
          <form method="get" class="row g-3 mb-3">
            <input type="hidden" name="tipo" value="feedbacks">

            <div class="col-md-3">
              <label class="form-label">Produto</label>
              <input type="text" name="produto" class="form-control" value="{{ request.GET.produto }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Usuário</label>
              <input type="text" name="usuario" class="form-control" value="{{ request.GET.usuario }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Nota</label>
              <select name="nota" class="form-select">
                <option value="">Todas</option>
                <option value="1" {% if request.GET.nota == "1" %}selected{% endif %}>1</option>
                <option value="2" {% if request.GET.nota == "2" %}selected{% endif %}>2</option>
                <option value="3" {% if request.GET.nota == "3" %}selected{% endif %}>3</option>
                <option value="4" {% if request.GET.nota == "4" %}selected{% endif %}>4</option>
                <option value="5" {% if request.GET.nota == "5" %}selected{% endif %}>5</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Visível</label>
              <select name="visivel" class="form-select">
                <option value="">Todos</option>
                <option value="True" {% if request.GET.visivel == "True" %}selected{% endif %}>Sim</option>
                <option value="False" {% if request.GET.visivel == "False" %}selected{% endif %}>Não</option>
              </select>
            </div>

            <div class="col-12 d-flex justify-content-end">
              <a href="{% url 'relatorio_avancado' %}" class="btn btn-secondary me-2">Resetar</a>
              <button type="submit" class="btn btn-primary">Atualizar</button>
            </div>
          </form>

          {% if tipo == "feedbacks" %}
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead class="table-dark">
                <tr>
                  <th>Usuário</th>
                  <th>Produto</th>
                  <th>Nota</th>
                  <th>Comentário</th>
                  <th>Visível</th>
                </tr>
              </thead>
              <tbody>
                {% for f in feedbacks %}
                <tr>
                  <td>{{ f.usuario.username }}</td>
                  <td>{{ f.produto.nome }}</td>
                  <td>{{ f.nota }} ⭐</td>
                  <td>{{ f.comentario|default:"-" }}</td>
                  <td>{% if f.visivel %}Sim{% else %}Não{% endif %}</td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center">Nenhum feedback encontrado.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}
