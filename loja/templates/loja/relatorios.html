{% extends 'loja/barra_lateral.html' %}
{% load static %}
{% block title %}Relatórios{% endblock %}

{% block content %}
<div class="pt-4 pb-3 mb-4 border-bottom">
  <h1 class="h2 fw-semibold">Relatórios</h1>
  <p class="text-muted mb-0">Visão geral das vendas e pedidos</p>
</div>

  <div class="row g-4">
    <!-- Gráfico 1: Vendas por mês (ano atual) -->
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h5 class="card-title">Vendas por mês (R$)</h5>
          <canvas id="chartVendasMes" height="160"></canvas>
        </div>
      </div>
    </div>

  <!-- Gráfico 2: Pedidos por status -->
  <div class="col-lg-4">
    <div class="card border-0 shadow-sm rounded-4">
      <div class="card-body">
        <h5 class="card-title">Pedidos por status</h5>
        <canvas id="chartStatus" height="160"></canvas>
      </div>
    </div>
  </div>

  <!-- Gráfico 3: Vendas por dia do mês atual -->
  <div class="col-12">
    <div class="card border-0 shadow-sm rounded-4">
      <div class="card-body">
        <h5 class="card-title">Vendas do mês (dia a dia)</h5>
        <canvas id="chartVendasDia" height="120"></canvas>
      </div>
    </div>
  </div>

  <!-- Tabela de apoio com totais por mês -->
  <div class="col-12">
    <div class="card border-0 shadow-sm rounded-4">
      <div class="card-body">
        <h5 class="card-title mb-3">Totais por mês (R$)</h5>
        <div class="table-responsive">
          <table class="table align-middle">
            <thead class="table-light">
              <tr>
                <th>Mês</th>
                <th class="text-end">Total</th>
              </tr>
            </thead>
            <tbody>
              {% for mes, total in tabela_mensal %}
              <tr>
                <td>{{ mes }}</td>
                <td class="text-end">R$ {{ total|floatformat:2 }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="2" class="text-center text-muted">Sem dados para o ano atual.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="text-end">
          <a href="{% url 'relatorios' %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-clockwise"></i> Atualizar
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  <!-- Chart.js (se já estiver incluso no layout, remova para evitar duplicar) -->
<script src="{% static 'loja/js/chart.js' %}"></script>

  <script>
    // Dados injetados pela view
    const mesLabels = {{ mes_labels_json|safe }};
    const mesValues = {{ mes_values_json|safe }};
    const diaLabels = {{ dia_labels_json|safe }};
    const diaValues = {{ dia_values_json|safe }};
    const statusLabels = {{ status_labels_json|safe }};
    const statusValues = {{ status_values_json|safe }};


// Gráfico: Vendas por mês
console.log('Dados do gráfico:', { mesLabels, mesValues });

// Validação dos dados
const labelsValidas = mesLabels && Array.isArray(mesLabels) ? mesLabels : [];
const valoresValidos = mesValues && Array.isArray(mesValues) ? mesValues : [];

console.log('Dados validados:', { labelsValidas, valoresValidos });

const ctxMes = document.getElementById('chartVendasMes').getContext('2d');
new Chart(ctxMes, {
    type: 'bar',
    data: {
        labels: labelsValidas,
        datasets: [{
            label: 'Faturamento (R$)',
            data: valoresValidos,
            backgroundColor: 'rgba(54, 162, 235, 0.8)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                    label: function(context) {
                        return 'R$ ' + Number(context.parsed.y).toLocaleString('pt-BR', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'R$ ' + Number(value).toLocaleString('pt-BR');
                    }
                }
            }
        }
    }
});

// Gráfico: Pedidos por status
const ctxStatus = document.getElementById('chartStatus').getContext('2d');

// Função para definir cores baseadas no status
function getStatusColors(labels) {
    return labels.map(label => {
        const labelLower = label.toLowerCase();
        if (labelLower === 'pago') {
            return '#4BC683'; // Verde
        } else if (labelLower === 'pendente') {
            return '#FF9F40'; // Laranja/Amarelo
        } else if (labelLower === 'cancelado') {
            return '#FF6384'; // Vermelho
        } else {
            return '#808080'; // Cinza para outros status
        }
    });
}

new Chart(ctxStatus, {
    type: 'doughnut',
    data: {
        labels: statusLabels,
        datasets: [{
            label: 'Qtd',
            data: statusValues,
            backgroundColor: getStatusColors(statusLabels),
            borderColor: getStatusColors(statusLabels),
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        return `${label}: ${value} pedidos`;
                    }
                }
            }
        }
    }
});

    // Gráfico: Vendas por dia no mês atual
    const ctxDia = document.getElementById('chartVendasDia').getContext('2d');
    new Chart(ctxDia, {
      type: 'bar',
      data: {
        labels: diaLabels,
        datasets: [{
          label: 'Faturamento (R$)',
          data: diaValues,
          tension: 0.35,
          fill: false,
          pointRadius: 2,
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          y: { beginAtZero: true, ticks: { callback: (v) => 'R$ ' + Number(v).toLocaleString('pt-BR') } }
        }
      }
    });
  </script>
{% endblock %}
