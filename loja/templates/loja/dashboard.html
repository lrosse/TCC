{% extends 'loja/barra_lateral.html' %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
  .metric-card {
    transition: transform 0.2s ease;
  }

  .metric-card:hover {
    transform: translateY(-4px);
  }

  .product-name, .feedback-text {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    word-break: break-word;
  }

  .star-rating {
    white-space: nowrap;
    display: inline-flex;
    gap: 2px;
    font-size: 1rem;
  }

  /* Responsividade */
  @media (max-width: 768px) {
    .container-fluid {
      padding-left: 1rem !important;
      padding-right: 1rem !important;
    }

    h1 {
      font-size: 1.5rem !important;
    }
  }
</style>

<div class="container-fluid px-4" style="background-color: #f8fafc; min-height: 100vh; padding-top: 2rem; padding-bottom: 3rem;">
  <!-- Cabeçalho -->
  <div class="d-flex justify-content-between align-items-center mb-4 p-4 bg-white rounded shadow-sm flex-wrap gap-3">
    <div>
      <h1 class="fw-bold mb-1" style="color: #1e293b; letter-spacing: -0.025em;">Olá, {{ user.username }}</h1>
      <p class="text-muted mb-0" style="font-size: 0.875rem;">
        Bem-vindo ao painel de controle
      </p>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <a href="{% url 'registrar' %}" class="btn btn-outline-success" style="border-radius: 8px; font-weight: 600;">
        <i class="bi bi-person-plus me-1"></i> Novo Usuário
      </a>
      <a href="{% url 'logout' %}" class="btn btn-outline-danger" style="border-radius: 8px; font-weight: 600;">
        <i class="bi bi-box-arrow-right me-1"></i> Sair
      </a>
    </div>
  </div>

  <!-- ROW 1: Resumo de Pedidos + Métricas Rápidas -->
  <div class="row g-4 mb-4">
    <!-- Pedidos -->
    <div class="col-lg-4">
      <div class="card shadow-sm h-100" style="border: none; border-radius: 12px;">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-semibold mb-0" style="color: #1e293b;">
              <i class="bi bi-box-seam me-2" style="color: #10b981;"></i>Pedidos
            </h6>
            <a href="{% url 'pedidos' %}" class="text-decoration-none" style="font-size: 0.875rem; color: #3b82f6; font-weight: 500;">
              Ver todos <i class="bi bi-arrow-right"></i>
            </a>
          </div>

          <!-- Resumo numérico -->
          <div class="row text-center mb-3">
            <div class="col">
              <span class="d-block fw-bold" style="font-size: 1.5rem; color: #f59e0b;">{{ pedidos_pendentes }}</span>
              <small class="text-muted">Pendentes</small>
            </div>
            <div class="col">
              <span class="d-block fw-bold" style="font-size: 1.5rem; color: #10b981;">{{ pedidos_pagos }}</span>
              <small class="text-muted">Pagos</small>
            </div>
            <div class="col">
              <span class="d-block fw-bold" style="font-size: 1.5rem; color: #ef4444;">{{ pedidos_cancelados }}</span>
              <small class="text-muted">Cancelados</small>
            </div>
          </div>

          <!-- Últimos pedidos -->
          <div style="max-height: 250px; overflow-y: auto;">
            {% for p in ultimos_pedidos %}
            <div class="d-flex justify-content-between align-items-center p-2 mb-2" style="background: #f8fafc; border-radius: 8px;">
              <div>
                <span class="fw-semibold" style="color: #64748b; font-size: 0.875rem;">#{{ p.numero_pedido }}</span>
                <span style="color: #94a3b8; font-size: 0.875rem;">– {{ p.cliente.username }}</span>
                <br>
                <small class="text-muted">R$ {{ p.total }}</small>
              </div>
              <span class="badge" style="{% if p.status == 'Pendente' %}background-color: #fef9c3; color: #92400e;{% elif p.status == 'Pago' %}background-color: #dcfce7; color: #15803d;{% else %}background-color: #fee2e2; color: #b91c1c;{% endif %} font-size: 0.75rem; padding: 4px 10px; border-radius: 6px;">
                {{ p.status }}
              </span>
            </div>
            {% empty %}
            <p class="text-muted text-center py-3 mb-0">Nenhum pedido encontrado</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Cards de Métricas -->
    <div class="col-lg-8">
      <div class="row g-3 h-100">
        <div class="col-md-6">
          <div class="card shadow-sm metric-card" style="border: none; border-radius: 12px;">
            <div class="card-body p-4 text-center">
              <i class="bi bi-cash-coin" style="font-size: 2.5rem; color: #10b981;"></i>
              <h6 class="fw-semibold mt-2 mb-1" style="color: #64748b;">Receita</h6>
              <p class="fw-bold mb-0" style="font-size: 1.25rem; color: #1e293b;">R$ {{ receita_total|floatformat:2 }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm metric-card" style="border: none; border-radius: 12px;">
            <div class="card-body p-4 text-center">
              <i class="bi bi-box-seam" style="font-size: 2.5rem; color: #3b82f6;"></i>
              <h6 class="fw-semibold mt-2 mb-1" style="color: #64748b;">Custos</h6>
              <p class="fw-bold mb-0" style="font-size: 1.25rem; color: #1e293b;">R$ {{ custo_total|floatformat:2 }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card shadow-sm metric-card" style="border: none; border-radius: 12px;">
            <div class="card-body p-3 text-center">
              <i class="bi bi-house-check" style="font-size: 2rem; color: #f59e0b;"></i>
              <h6 class="fw-semibold mt-2 mb-1" style="font-size: 0.875rem; color: #64748b;">Fixas</h6>
              <p class="fw-bold mb-0" style="color: #1e293b;">R$ {{ despesas_fixas|floatformat:2 }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card shadow-sm metric-card" style="border: none; border-radius: 12px;">
            <div class="card-body p-3 text-center">
              <i class="bi bi-receipt" style="font-size: 2rem; color: #ef4444;"></i>
              <h6 class="fw-semibold mt-2 mb-1" style="font-size: 0.875rem; color: #64748b;">Variáveis</h6>
              <p class="fw-bold mb-0" style="color: #1e293b;">R$ {{ despesas_variaveis|floatformat:2 }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card shadow-sm metric-card" style="border: none; border-radius: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <div class="card-body p-3 text-center">
              <i class="bi bi-graph-up text-white" style="font-size: 2rem;"></i>
              <h6 class="fw-semibold mt-2 mb-1 text-white" style="font-size: 0.875rem;">Lucro</h6>
              <p class="fw-bold mb-0 text-white">R$ {{ lucro_liquido|floatformat:2 }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vendas do Mês -->
  <div class="card shadow-sm mb-4" style="border: none; border-radius: 12px;">
    <div class="card-body p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-semibold mb-0" style="color: #1e293b;">
          <i class="bi bi-bar-chart-line me-2" style="color: #3b82f6;"></i>Vendas do Mês
        </h6>
        <a href="{% url 'financeiro_resumo' %}" class="text-decoration-none" style="font-size: 0.875rem; color: #3b82f6; font-weight: 500;">
          Ver detalhes <i class="bi bi-arrow-right"></i>
        </a>
      </div>
      <canvas id="miniChartMes" height="80"></canvas>
    </div>
  </div>

  <!-- Resumo Financeiro -->
  <div class="row g-3 mb-4">

  <!-- Top 5 Produtos -->
  <div class="card shadow-sm mb-4" style="border: none; border-radius: 12px;">
    <div class="card-body p-4">
      <h6 class="fw-semibold mb-4 pb-3" style="color: #1e293b; border-bottom: 2px solid #f1f5f9;">
        <i class="bi bi-bar-chart-line me-2" style="color: #3b82f6;"></i>Top 5 Produtos Mais Vendidos
      </h6>

      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead style="background: #f8fafc;">
            <tr>
              <th style="color: #64748b; font-weight: 500; font-size: 0.75rem; padding: 1rem 1.25rem;">Produto</th>
              <th style="color: #64748b; font-weight: 500; font-size: 0.75rem; text-align: center;">Última Venda</th>
              <th style="color: #64748b; font-weight: 500; font-size: 0.75rem; text-align: right;">Unidades Vendidas</th>
            </tr>
          </thead>
          <tbody>
            {% for item in top_produtos %}
            <tr style="border-bottom: 1px solid #e2e8f0;">
              <td style="padding: 1rem 1.25rem;">
                <span class="product-name" style="font-weight: 600; color: #1e293b;">{{ item.produto__nome }}</span>
              </td>
              <td style="text-align: center;">
                <span style="color: #64748b; font-size: 0.875rem;">{{ item.ultima_venda|date:"d/m/Y H:i" }}</span>
              </td>
              <td style="text-align: right;">
                <span class="badge" style="background-color: #dcfce7; color: #15803d; padding: 6px 14px; font-size: 0.8125rem; font-weight: 600; border-radius: 6px;">
                  <i class="bi bi-box-seam me-1"></i>{{ item.total_vendido }} unidades
                </span>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="3" class="text-center py-5" style="color: #64748b;">
                <i class="bi bi-inbox display-4 mb-3 d-block"></i>
                <p class="mb-0">Nenhuma venda registrada ainda.</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Últimos Feedbacks -->
  <div class="card shadow-sm" style="border: none; border-radius: 12px;">
    <div class="card-body p-4">
      <h6 class="fw-semibold mb-4 pb-3" style="color: #1e293b; border-bottom: 2px solid #f1f5f9;">
        <i class="bi bi-chat-dots me-2" style="color: #8b5cf6;"></i>Últimos Feedbacks
      </h6>

      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead style="background: #f8fafc;">
            <tr>
              <th style="color: #64748b; font-weight: 500; font-size: 0.75rem; padding: 1rem 1.25rem;">Produto</th>
              <th style="color: #64748b; font-weight: 500; font-size: 0.75rem; text-align: center;">Cliente</th>
              <th style="color: #64748b; font-weight: 500; font-size: 0.75rem;">Comentário</th>
              <th style="color: #64748b; font-weight: 500; font-size: 0.75rem; text-align: center;">Avaliação</th>
              <th style="color: #64748b; font-weight: 500; font-size: 0.75rem; text-align: right;">Data</th>
            </tr>
          </thead>
          <tbody>
            {% for f in feedbacks %}
            <tr style="border-bottom: 1px solid #e2e8f0;">
              <td style="padding: 1rem 1.25rem;">
                <span class="product-name" style="font-weight: 600; color: #1e293b;">{{ f.produto.nome }}</span>
              </td>
              <td style="text-align: center;">
                <span style="color: #64748b; font-weight: 500;">{{ f.usuario.username }}</span>
              </td>
              <td>
                <span class="feedback-text" style="color: #64748b; font-size: 0.875rem;">{{ f.comentario }}</span>
              </td>
              <td style="text-align: center;">
                <span class="star-rating">
                  {% for i in "12345" %}
                    {% if forloop.counter <= f.nota %}
                      <i class="bi bi-star-fill" style="color: #fbbf24;"></i>
                    {% else %}
                      <i class="bi bi-star" style="color: #d1d5db;"></i>
                    {% endif %}
                  {% endfor %}
                </span>
              </td>
              <td style="text-align: right;">
                <span style="color: #94a3b8; font-size: 0.875rem;">{{ f.data_criacao|date:"d/m/Y H:i" }}</span>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center py-5" style="color: #64748b;">
                <i class="bi bi-inbox display-4 mb-3 d-block"></i>
                <p class="mb-0">Nenhum feedback encontrado.</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'loja/js/chart.js' %}"></script>
<script>
const miniLabels = {{ mini_mes_labels_json|safe }};
const miniValues = {{ mini_mes_values_json|safe }};

const canvas = document.getElementById('miniChartMes');
if (canvas) {
  const ctxMini = canvas.getContext('2d');
  new Chart(ctxMini, {
    type: 'bar',
    data: {
      labels: miniLabels,
      datasets: [{
        label: 'Faturamento (R$)',
        data: miniValues,
        backgroundColor: 'rgba(59, 130, 246, 0.7)',
        borderColor: 'rgba(59, 130, 246, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => 'R$ ' + ctx.raw.toLocaleString('pt-BR')
          }
        }
      },
      scales: {
        x: { 
          title: { display: true, text: 'Dia do mês' },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          ticks: { callback: (v) => 'R$ ' + v.toLocaleString('pt-BR') }
        }
      }
    }
  });
}
</script>
{% endblock %}