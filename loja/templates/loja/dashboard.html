{% extends 'loja/barra_lateral.html' %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-4 pb-3 mb-4 border-bottom">
  <h1 class="h2 fw-semibold">OlÃ¡, {{ user.username }}</h1>
  <div class="btn-toolbar">
    <a href="{% url 'registrar' %}" class="btn btn-outline-success btn-sm me-2">
      <i class="bi bi-person-plus"></i> Registrar Novo UsuÃ¡rio
    </a>
    <a href="{% url 'logout' %}" class="btn btn-outline-danger btn-sm">
      <i class="bi bi-box-arrow-right"></i> Sair
    </a>
  </div>
</div>

<!-- ROW 1: Vendas do mÃªs + Resumo de Pedidos -->
<div class="row g-4">
  <!-- ðŸ“Š Mini grÃ¡fico do mÃªs -->
  <div class="col-12 col-lg-6">
    <div class="card border-0 shadow-sm rounded-4 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="card-title mb-0">ðŸ“Š Vendas (mÃªs atual)</h5>
          <a href="{% url 'financeiro_resumo' %}" class="text-decoration-none small">
            Ver detalhes <i class="bi bi-arrow-right-short"></i>
          </a>
        </div>
        <canvas id="miniChartMes" height="120"></canvas>
      </div>
    </div>
  </div>

  <!-- ðŸ“¦ Pedidos -->
  <div class="col-12 col-lg-6">
    <div class="card border-0 shadow-sm rounded-4 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="card-title fw-bold">ðŸ“¦ Pedidos</h5>
          <a href="{% url 'pedidos' %}" class="text-decoration-none small">
            Ver todos <i class="bi bi-arrow-right-short"></i>
          </a>
        </div>

        <!-- Resumo numÃ©rico -->
        <div class="row text-center mb-3">
          <div class="col">
            <span class="d-block fw-bold">{{ pedidos_pendentes }}</span>
            <small class="text-muted">Pendentes</small>
          </div>
          <div class="col">
            <span class="d-block fw-bold text-success">{{ pedidos_pagos }}</span>
            <small class="text-muted">Pagos</small>
          </div>
          <div class="col">
            <span class="d-block fw-bold text-danger">{{ pedidos_cancelados }}</span>
            <small class="text-muted">Cancelados</small>
          </div>
        </div>

        <!-- Ãšltimos pedidos -->
        <ul class="list-group list-group-flush small">
          {% for p in ultimos_pedidos %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <span class="fw-semibold">#{{ p.numero_pedido }}</span> â€“ {{ p.cliente.username }}
              <br>
              <small class="text-muted">R$ {{ p.total }}</small>
            </div>
            <span class="badge
              {% if p.status == 'Pendente' %} bg-warning text-dark
              {% elif p.status == 'Pago' %} bg-success
              {% elif p.status == 'Cancelado' %} bg-danger
              {% else %} bg-secondary{% endif %}">
              {{ p.status }}
            </span>
          </li>
          {% empty %}
          <li class="list-group-item text-muted text-center">Nenhum pedido encontrado</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- ðŸ’° Vendas no mÃªs -->
<div class="row g-4 mt-1">
  <div class="col-12">
    <div class="card border-0 shadow-sm rounded-4">
      <div class="card-body text-center">
        <h5 class="card-title fw-bold">ðŸ’° Vendas no mÃªs</h5>
        <p class="fs-4 text-success mb-0">R$ {{ vendas_mes|floatformat:2 }}</p>
      </div>
    </div>
  </div>
</div>

<!-- ROW 2: Top 5 Produtos -->
<div class="row g-4 mt-1">
  <div class="col-12">
    <div class="card shadow-sm rounded-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-bar-chart-line"></i> Top 5 Produtos Mais Vendidos</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="w-50">Produto</th>
                <th class="w-25 text-center">Ãšltima Venda</th>
                <th class="w-25 text-end">Unidades</th>
              </tr>
            </thead>
            <tbody>
              {% for item in top_produtos %}
              <tr>
                <td><span class="fw-semibold product-name">{{ item.produto__nome }}</span></td>
                <td class="text-center text-muted small">{{ item.ultima_venda|date:"d/m/Y H:i" }}</td>
                <td class="text-end">
                  <span class="badge bg-gradient-success fs-6 px-3 py-2 shadow-sm">
                    <i class="bi bi-box-seam"></i> {{ item.total_vendido }} unidades
                  </span>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="3" class="text-center text-muted">Nenhuma venda registrada ainda.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ROW 3: Feedbacks -->
<div class="row g-4 mt-1">
  <div class="col-12">
    <div class="card shadow-sm rounded-4">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="bi bi-chat-dots"></i> Ãšltimos Feedbacks</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="w-25">Produto</th>
                <th class="w-15 text-center">Cliente</th>
                <th class="w-25">ComentÃ¡rio</th>
                <th class="w-20 text-center">AvaliaÃ§Ã£o</th>
                <th class="w-15 text-end">Data</th>
              </tr>
            </thead>
            <tbody>
              {% for f in feedbacks %}
              <tr>
                <td><span class="product-name">{{ f.produto.nome }}</span></td>
                <td class="text-center fw-semibold">{{ f.usuario.username }}</td>
                <td><span class="feedback-text">{{ f.comentario }}</span></td>
                <td class="text-center">
                  <span class="star-rating">
                    {% for i in "12345" %}
                      {% if forloop.counter <= f.nota %}
                        <i class="bi bi-star-fill text-warning"></i>
                      {% else %}
                        <i class="bi bi-star text-muted"></i>
                      {% endif %}
                    {% endfor %}
                  </span>
                </td>
                <td class="text-end text-muted small">{{ f.data_criacao|date:"d/m/Y H:i" }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted">Nenhum feedback encontrado.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CSS unificado -->
<style>
.product-name, .feedback-text {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  word-break: break-word;
}

.bg-gradient-success {
  background: linear-gradient(90deg, #28a745, #218838);
  color: #fff;
  border-radius: 30px;
}

/* ðŸ”¹ Evita quebra das estrelas */
.star-rating {
  white-space: nowrap;  /* mantÃ©m tudo na mesma linha */
  display: inline-flex; /* alinha horizontalmente */
  gap: 2px;             /* espaÃ§o entre estrelas */
  font-size: 1rem;      /* tamanho fixo das estrelas */
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'loja/js/chart.js' %}"></script>
<script>
const miniLabels = {{ mini_mes_labels_json|safe }};
const miniValues = {{ mini_mes_values_json|safe }};

const canvas = document.getElementById('miniChartMes');
if (canvas) {
  const ctxMini = canvas.getContext('2d');
  new Chart(ctxMini, {
    type: 'bar',
    data: {
      labels: miniLabels,
      datasets: [{
        label: 'Faturamento (R$)',
        data: miniValues,
        backgroundColor: 'rgba(54, 162, 235, 0.6)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => 'R$ ' + ctx.raw.toLocaleString('pt-BR')
          }
        }
      },
      scales: {
        x: { title: { display: true, text: 'Dia do mÃªs' } },
        y: {
          beginAtZero: true,
          ticks: { callback: (v) => 'R$ ' + v.toLocaleString('pt-BR') }
        }
      }
    }
  });
}
</script>
{% endblock %}
