<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vitrine de Produtos</title>

  <!-- Bootstrap CSS + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body { background-color: #ffffff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .product-card { border-radius: 12px; overflow: hidden; transition: transform .2s ease, box-shadow .2s ease; }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 6px 20px rgba(0,0,0,.1); }
    .product-img { height: 250px; object-fit: cover; width: 100%; }

    .card-body {
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

    .card-title {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      min-height: 3.6em;
    }

    .card-footer {
      margin-top: auto;
    }
  </style>
</head>
<body>

<!-- üîπ Navbar -->
{% include "loja/_navbar.html" %}

<!-- üîπ Vitrine -->
<div class="container my-5">
  <h1 class="text-center text-primary mb-5">Vitrine de Produtos</h1>
  <div class="row" id="vitrine-produtos">
    {% for produto in produtos %}
      <div class="col-md-3 col-sm-6 mb-4 produto-card"
           data-nome="{{ produto.nome|lower }}"
           data-preco="{{ produto.preco }}"
           data-nota="{{ produto.media_nota|default:0 }}">
        <div class="card h-100 shadow-sm product-card">

          <a href="{% url 'produto_detalhe' produto.id %}" class="text-decoration-none text-dark">
            {% if produto.imagem %}
              <img src="{{ produto.imagem.url }}" class="card-img-top product-img" alt="{{ produto.nome }}">
            {% endif %}
            <div class="card-body text-center">
              <h5 class="card-title fw-semibold">{{ produto.nome }}</h5>
              <p class="card-text fw-bold text-success fs-5">R$ {{ produto.preco }}</p>
            </div>
          </a>

          <!-- Bot√£o adicionar (rota AJAX correta) -->
          <div class="card-footer bg-white border-0 p-3">
            <form method="post" action="{% url 'adicionar_carrinho' produto.id %}" class="add-carrinho-form">
              {% csrf_token %}
              <button type="submit" class="btn btn-primary btn-sm w-100">
                <i class="bi bi-cart-plus me-1"></i> Adicionar ao Carrinho
              </button>
            </form>
          </div>

        </div>
      </div>
    {% empty %}
      <p class="text-center text-muted">Nenhum produto dispon√≠vel.</p>
    {% endfor %}
  </div>
</div>

<!-- üîπ Container para Toasts -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 2000;">
  <div id="toast-carrinho" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        ‚úÖ Produto adicionado ao carrinho!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Script AJAX -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll(".add-carrinho-form").forEach(form => {
    form.addEventListener("submit", async function(e) {
      e.preventDefault();

      const url = this.action;
      const csrfToken = this.querySelector("[name=csrfmiddlewaretoken]").value;

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest"
          }
        });

        const data = await response.json();
        console.log("Resposta do backend:", data);

        if (data.success) {
          const badge = document.querySelector("#carrinho-contador");
          if (badge) {
            badge.textContent = data.total_itens;
          }

          // Exibe toast de sucesso
          const toastEl = document.getElementById("toast-carrinho");
          const toast = new bootstrap.Toast(toastEl, {
            autohide: true,   // üîπ some automaticamente
            delay: 2000       // üîπ tempo em ms (3 segundos)
          });
          toast.show();

        } else {
          alert("‚ö†Ô∏è N√£o foi poss√≠vel adicionar ao carrinho.");
        }
      } catch (error) {
        console.error("Erro:", error);
        alert("‚ùå Erro ao adicionar produto.");
      }
    });
  });
});
</script>
</body>
</html>
