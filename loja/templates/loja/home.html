<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vitrine de Produtos</title>

  <!-- Bootstrap CSS + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background-color: #ffffff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .product-card {
      border-radius: 12px;
      overflow: hidden;
      transition: transform .2s ease, box-shadow .2s ease;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, .1);
    }

    .product-img {
      height: 250px;
      object-fit: cover;
      width: 100%;
    }

    .card-body {
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

    .card-title {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      min-height: 3.6em;
    }

    .card-footer {
      margin-top: auto;
    }

    .pagination .page-item .page-link {
      border-radius: 8px;
      /* cantos arredondados */
      margin: 0 3px;
      /* espa√ßamento entre bot√µes */
      color: #0d6efd;
      /* azul Bootstrap */
      font-weight: 500;
      transition: all 0.2s ease-in-out;
    }

    .pagination .page-item.active .page-link {
      background-color: #0d6efd;
      /* fundo azul ativo */
      border-color: #0d6efd;
      color: #fff;
      font-weight: 600;
      box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
    }

    .pagination .page-item .page-link:hover {
      background-color: #e9f2ff;
      /* azul clarinho no hover */
      color: #0a58ca;
      transform: translateY(-2px);
      /* sobe levemente no hover */
    }

    .pagination .page-item.disabled .page-link {
      color: #adb5bd;
      /* cinza */
      background-color: #f8f9fa;
    }
  </style>
</head>

<body>

  <!-- üîπ Navbar -->
  {% include "loja/_navbar.html" %}

  <!-- üîπ Vitrine -->
  <div class="container my-5">
    <!-- üîπ Filtros -->
<form method="get" class="d-flex justify-content-center mb-4">
  <!-- Barra de pesquisa -->
  <input type="text" name="q" class="form-control w-50 me-2"
         placeholder="Buscar produto..." value="{{ request.GET.q }}">

  <!-- Bot√£o de filtros -->
  <div class="dropdown">
    <button class="btn btn-outline-primary" type="button" id="filtrosDropdown"
            data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-funnel-fill"></i> Filtros
    </button>

    <!-- Op√ß√µes de filtros -->
    <div class="dropdown-menu p-3 shadow-lg" style="min-width: 400px;" aria-labelledby="filtrosDropdown">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label small fw-semibold">Pre√ßo m√≠n.</label>
          <input type="number" step="0.01" name="preco_min" class="form-control"
                 value="{{ request.GET.preco_min }}">
        </div>
        <div class="col-md-6">
          <label class="form-label small fw-semibold">Pre√ßo m√°x.</label>
          <input type="number" step="0.01" name="preco_max" class="form-control"
                 value="{{ request.GET.preco_max }}">
        </div>
        <div class="col-md-6">
          <label class="form-label small fw-semibold">Nota m√≠n.</label>
          <input type="number" step="0.1" name="nota_min" class="form-control"
                 value="{{ request.GET.nota_min }}">
        </div>
      </div>
      <div class="mt-3 d-flex justify-content-between">
        <!-- Bot√£o limpar volta para a home sem par√¢metros -->
        <a href="{% url 'home' %}" class="btn btn-outline-danger">
          <i class="bi bi-x-circle"></i> Limpar
        </a>
        <!-- Submete o form -->
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-search"></i> Aplicar
        </button>
      </div>
    </div>
  </div>
</form>

<div class="row" id="vitrine-produtos">
  {% for produto in page_obj %}
  <div class="col-md-3 col-sm-6 mb-4 produto-card" data-nome="{{ produto.nome|lower }}"
    data-preco="{{ produto.preco }}" data-nota="{{ produto.media_nota|default:0 }}">
    <div class="card h-100 shadow-sm product-card">
      <a href="{% url 'produto_detalhe' produto.id %}" class="text-decoration-none text-dark">
        {% if produto.imagem %}
        <img src="{{ produto.imagem.url }}" class="card-img-top product-img" alt="{{ produto.nome }}">
        {% endif %}
        <div class="card-body text-center">
          <h5 class="card-title fw-semibold">{{ produto.nome }}</h5>
          <p class="card-text fw-bold text-success fs-5">R$ {{ produto.preco }}</p>
        </div>
      </a>
      <div class="card-footer bg-white border-0 p-3">
        <form method="post" action="{% url 'adicionar_carrinho' produto.id %}" class="add-carrinho-form">
          {% csrf_token %}
          <button type="submit" class="btn btn-primary btn-sm w-100">
            <i class="bi bi-cart-plus me-1"></i> Adicionar ao Carrinho
          </button>
        </form>
      </div>
    </div>
  </div>
  {% empty %}
  <p class="text-center text-muted">Nenhum produto dispon√≠vel.</p>
  {% endfor %}
</div>

    <!-- üîπ Pagina√ß√£o -->
    {% with request.GET.urlencode as querystring %}
    {% if page_obj.has_other_pages %}
    <nav aria-label="Navega√ß√£o de p√°ginas">
      <ul class="pagination justify-content-center mt-4">
        {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?{{ querystring }}&page={{ page_obj.previous_page_number }}">&laquo;</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
        {% if num == page_obj.number %}
        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% else %}
        <li class="page-item"><a class="page-link" href="?{{ querystring }}&page={{ num }}">{{ num }}</a></li>
        {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?{{ querystring }}&page={{ page_obj.next_page_number }}">&raquo;</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
    {% endwith %}
  </div>

  <!-- üîπ Toast -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 2000;">
    <div id="toast-carrinho" class="toast align-items-center text-bg-success border-0" role="alert"
      aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          ‚úÖ Produto adicionado ao carrinho!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script AJAX -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".add-carrinho-form").forEach(form => {
        form.addEventListener("submit", async function (e) {
          e.preventDefault();

          const url = this.action;
          const csrfToken = this.querySelector("[name=csrfmiddlewaretoken]").value;

          try {
            const response = await fetch(url, {
              method: "POST",
              headers: {
                "X-CSRFToken": csrfToken,
                "X-Requested-With": "XMLHttpRequest"
              }
            });

            const data = await response.json();
            console.log("Resposta do backend:", data);

            if (data.success) {
              const badge = document.querySelector("#carrinho-contador");
              if (badge) {
                badge.textContent = data.total_itens;
              }

              // Exibe toast
              const toastEl = document.getElementById("toast-carrinho");
              const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 3000 });
              toast.show();
            } else {
              alert("‚ö†Ô∏è N√£o foi poss√≠vel adicionar ao carrinho.");
            }
          } catch (error) {
            console.error("Erro:", error);
            alert("‚ùå Erro ao adicionar produto.");
          }
        });
      });
    });
  </script>
</body>

</html>