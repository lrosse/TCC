<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vitrine de Produtos</title>

  <!-- Bootstrap CSS + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background-color: #ffffff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .product-card {
      border-radius: 12px;
      overflow: hidden;
      transition: transform .2s ease, box-shadow .2s ease;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, .1);
    }

    .product-img {
      height: 250px;
      object-fit: cover;
      width: 100%;
    }

    .card-body {
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

    .card-title {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      min-height: 3.6em;
    }

    .card-footer {
      margin-top: auto;
    }

    .pagination .page-item .page-link {
      border-radius: 8px;
      margin: 0 3px;
      color: #0d6efd;
      font-weight: 500;
      transition: all 0.2s ease-in-out;
    }

    .pagination .page-item.active .page-link {
      background-color: #0d6efd;
      border-color: #0d6efd;
      color: #fff;
      font-weight: 600;
      box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
    }

    .pagination .page-item .page-link:hover {
      background-color: #e9f2ff;
      color: #0a58ca;
      transform: translateY(-2px);
    }

    .pagination .page-item.disabled .page-link {
      color: #adb5bd;
      background-color: #f8f9fa;
    }
  </style>
</head>

<body>

  <!-- üîπ Navbar -->
  {% include "loja/_navbar.html" %}

  <!-- üîπ Vitrine -->
  <div class="container my-5">

    <!-- üîπ Barra de Pesquisa + Bot√£o + Filtro -->
    <form method="get" class="row g-2 mb-4 justify-content-center align-items-center">
      <!-- Barra de pesquisa -->
      <div class="col-md-6 position-relative">
        <input type="text" name="q" id="campo-busca" class="form-control"
          placeholder="Buscar produto..." value="{{ request.GET.q }}" autocomplete="off">

        <!-- Resultados do autocomplete -->
        <ul id="resultados-busca"
          class="list-group position-absolute w-100 shadow-sm mt-1 d-none"
          style="z-index:1050; max-height:300px; overflow-y:auto;"></ul>
      </div>

      <!-- Bot√£o buscar -->
      <div class="col-md-auto">
        <button type="submit" class="btn btn-primary px-4">
          <i class="bi bi-search"></i> Buscar
        </button>
      </div>

      <!-- Bot√£o filtro -->
      <div class="col-md-auto">
        <div class="dropdown">
          <button class="btn btn-outline-secondary px-4" type="button" id="filtroDropdown"
            data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-funnel"></i> Filtros
          </button>

          <!-- Op√ß√µes do filtro -->
          <div class="dropdown-menu p-3 shadow-lg" style="min-width: 400px;" aria-labelledby="filtroDropdown">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label small fw-semibold">Pre√ßo m√≠n.</label>
                <input type="number" step="0.01" name="preco_min" class="form-control"
                  placeholder="Ex: 100" value="{{ request.GET.preco_min }}">
              </div>
              <div class="col-md-6">
                <label class="form-label small fw-semibold">Pre√ßo m√°x.</label>
                <input type="number" step="0.01" name="preco_max" class="form-control"
                  placeholder="Ex: 1000" value="{{ request.GET.preco_max }}">
              </div>
              <div class="col-md-12">
                <label class="form-label small fw-semibold">Avalia√ß√£o</label>
                <select name="nota_min" class="form-select">
                  <option value="">Todas</option>
                  <option value="1" {% if request.GET.nota_min == "1" %}selected{% endif %}>‚≠ê 1+</option>
                  <option value="2" {% if request.GET.nota_min == "2" %}selected{% endif %}>‚≠ê 2+</option>
                  <option value="3" {% if request.GET.nota_min == "3" %}selected{% endif %}>‚≠ê 3+</option>
                  <option value="4" {% if request.GET.nota_min == "4" %}selected{% endif %}>‚≠ê 4+</option>
                  <option value="5" {% if request.GET.nota_min == "5" %}selected{% endif %}>‚≠ê 5</option>
                </select>
              </div>
            </div>
            <div class="mt-3">
              <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-search"></i> Aplicar Filtros
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>

    <!-- üîπ Lista de Produtos -->
    <div class="row" id="vitrine-produtos">
      {% for produto in page_obj %}
      <div class="col-md-3 col-sm-6 mb-4 produto-card"
        data-nome="{{ produto.nome|lower }}"
        data-preco="{{ produto.preco }}"
        data-nota="{{ produto.media_nota|default:0 }}">
        <div class="card h-100 shadow-sm product-card">
          <a href="{% url 'produto_detalhe' produto.id %}" class="text-decoration-none text-dark">
            {% if produto.imagem %}
            <img src="{{ produto.imagem.url }}" class="card-img-top product-img" alt="{{ produto.nome }}">
            {% endif %}
            <div class="card-body text-center">
              <h5 class="card-title fw-semibold">{{ produto.nome }}</h5>
              <p class="card-text fw-bold text-success fs-5">R$ {{ produto.preco }}</p>
            </div>
          </a>
          <div class="card-footer bg-white border-0 p-3">
            <form method="post" action="{% url 'adicionar_carrinho' produto.id %}" class="add-carrinho-form">
              {% csrf_token %}
              <button type="submit" class="btn btn-primary btn-sm w-100">
                <i class="bi bi-cart-plus me-1"></i> Adicionar ao Carrinho
              </button>
            </form>
          </div>
        </div>
      </div>
      {% empty %}
      <p class="text-center text-muted">Nenhum produto dispon√≠vel.</p>
      {% endfor %}
    </div>

    <!-- üîπ Pagina√ß√£o -->
    {% with request.GET.urlencode as querystring %}
    {% if page_obj.has_other_pages %}
    <nav aria-label="Navega√ß√£o de p√°ginas">
      <ul class="pagination justify-content-center mt-4">
        {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?{{ querystring }}&page={{ page_obj.previous_page_number }}">&laquo;</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
        {% if num == page_obj.number %}
        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% else %}
        <li class="page-item"><a class="page-link" href="?{{ querystring }}&page={{ num }}">{{ num }}</a></li>
        {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?{{ querystring }}&page={{ page_obj.next_page_number }}">&raquo;</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
    {% endwith %}
  </div>

  <!-- üîπ Toast -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 2000;">
    <div id="toast-carrinho" class="toast align-items-center text-bg-success border-0" role="alert"
      aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          ‚úÖ Produto adicionado ao carrinho!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script AJAX Carrinho + Autocomplete -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // üîπ Atualiza√ß√£o carrinho AJAX
      document.querySelectorAll(".add-carrinho-form").forEach(form => {
        form.addEventListener("submit", async function (e) {
          e.preventDefault();

          const url = this.action;
          const csrfToken = this.querySelector("[name=csrfmiddlewaretoken]").value;

          try {
            const response = await fetch(url, {
              method: "POST",
              headers: {
                "X-CSRFToken": csrfToken,
                "X-Requested-With": "XMLHttpRequest"
              }
            });

            const data = await response.json();
            if (data.success) {
              const badge = document.querySelector("#carrinho-contador");
              if (badge) {
                badge.textContent = data.total_itens;
              }

              // Exibe toast
              const toastEl = document.getElementById("toast-carrinho");
              const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 3000 });
              toast.show();
            } else {
              alert("‚ö†Ô∏è N√£o foi poss√≠vel adicionar ao carrinho.");
            }
          } catch (error) {
            console.error("Erro:", error);
            alert("‚ùå Erro ao adicionar produto.");
          }
        });
      });

      // üîπ Autocomplete pesquisa
      const campoBusca = document.getElementById("campo-busca");
      const resultados = document.getElementById("resultados-busca");

      campoBusca.addEventListener("input", async function () {
        const termo = this.value.trim();
        if (termo.length < 2) {
          resultados.classList.add("d-none");
          return;
        }

        try {
          const response = await fetch(`/buscar-produtos/?q=${encodeURIComponent(termo)}`);
          const data = await response.json();

          resultados.innerHTML = "";

          if (data.length > 0) {
            data.forEach(prod => {
              const item = document.createElement("li");
              item.classList.add("list-group-item", "d-flex", "align-items-center", "gap-2");

              item.innerHTML = `
                <img src="${prod.imagem}" alt="${prod.nome}" 
                     style="width:40px; height:40px; object-fit:cover; border-radius:6px;">
                <a href="${prod.url}" class="text-decoration-none flex-grow-1">${prod.nome}</a>
              `;

              resultados.appendChild(item);
            });
            resultados.classList.remove("d-none");
          } else {
            resultados.classList.add("d-none");
          }

        } catch (error) {
          console.error("Erro ao buscar produtos:", error);
        }
      });

      // Esconde resultados ao clicar fora
      document.addEventListener("click", (e) => {
        if (!e.target.closest("#campo-busca") && !e.target.closest("#resultados-busca")) {
          resultados.classList.add("d-none");
        }
      });
    });
  </script>
</body>

</html>
