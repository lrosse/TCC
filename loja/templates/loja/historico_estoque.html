{% extends 'loja/barra_lateral.html' %}
{% block title %}Histórico de Estoque{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="fw-semibold mb-0">Histórico de estoque</h2>
        <a href="{% url 'ajuste_estoque' %}" class="btn btn-outline-success">
            <i class="bi bi-box-arrow-in-down"></i> Nova Entrada
        </a>
    </div>

    <!-- Barra de pesquisa principal e botão de filtro -->
    <form class="row g-3 align-items-end mb-3" onsubmit="return false;">
        <div class="col-md-4">
            <input type="text" id="filtro-nome" class="form-control shadow-sm" placeholder="Digite o nome...">
        </div>
        <div class="col-auto">
            <label class="form-label d-block">&nbsp;</label>
            <button class="btn btn-outline-secondary shadow-sm" type="button" 
                    data-bs-toggle="collapse" data-bs-target="#filtrosExtras" 
                    aria-expanded="false" aria-controls="filtrosExtras">
                <i class="bi bi-funnel-fill"></i> Filtros
            </button>
        </div>
    </form>

    <!-- Filtros colapsáveis -->
    <div class="collapse mb-4" id="filtrosExtras">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Data</label>
                <input type="date" id="filtro-data" class="form-control shadow-sm">
            </div>
            <div class="col-md-3">
                <label class="form-label">Tipo</label>
                <select id="filtro-tipo" class="form-select shadow-sm">
                    <option value="">Todos</option>
                    <option value="entrada">Entrada</option>
                    <option value="saida">Saída</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">ID do Produto</label>
                <input type="text" id="filtro-id" class="form-control shadow-sm" placeholder="Ex.: 12">
            </div>
            <div class="col-md-2">
                <label class="form-label d-block">&nbsp;</label>
                <button type="button" id="btn-limpar" class="btn btn-outline-danger form-control">
                    <i class="bi bi-x-circle"></i> Limpar
                </button>
            </div>
        </div>
    </div>

    <!-- Tabela com histórico -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped align-middle text-center" id="tabela-movimentacoes">
                    <thead class="table-dark">
                        <tr>
                            <th>Data e Hora</th>
                            <th>ID</th>
                            <th>Produto</th>
                            <th>Tipo</th>
                            <th>Quantidade</th>
                            <th>Estoque Final</th>
                            <th>Observação</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mov in movimentacoes %}
                        <tr
                          data-id="{{ mov.produto.id }}"
                          data-nome="{{ mov.produto.nome|lower }}"
                          data-tipo="{% if mov.tipo == 'ajuste' %}saida{% else %}{{ mov.tipo }}{% endif %}"
                          data-date="{{ mov.data|date:'Y-m-d H:i' }}"
                        >
                            <td>{{ mov.data|date:"d/m/Y H:i" }}</td>
                            <td>{{ mov.produto.id }}</td>
                            <td>{{ mov.produto.nome }}</td>
                            <td>
                                {% if mov.tipo == 'entrada' %}
                                  <span class="badge bg-success">Entrada</span>
                                {% elif mov.tipo == 'saida' or mov.tipo == 'ajuste' %}
                                  <span class="badge bg-danger">Saída</span>
                                {% else %}
                                  <span class="badge bg-secondary">{{ mov.tipo|capfirst }}</span>
                                {% endif %}
                            </td>
                            <td>{{ mov.quantidade }}</td>
                            <td>{{ mov.estoque_final }}</td>
                            <td>{{ mov.observacao }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-muted">Nenhuma movimentação registrada.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filtrarTabela() {
  const idVal   = (document.getElementById('filtro-id').value || '').trim().toLowerCase();
  const nomeVal = (document.getElementById('filtro-nome').value || '').trim().toLowerCase();
  const dataVal = (document.getElementById('filtro-data').value || '').trim();
  const tipoVal = (document.getElementById('filtro-tipo').value || '').trim().toLowerCase();

  const linhas = document.querySelectorAll('#tabela-movimentacoes tbody tr');

  linhas.forEach(linha => {
    const liId   = (linha.dataset.id || '').toLowerCase();
    const liNome = (linha.dataset.nome || '').toLowerCase();
    const liDate = (linha.dataset.date || '').slice(0,10); // só compara a parte da data (AAAA-MM-DD)
    const liTipo = (linha.dataset.tipo || '').toLowerCase();

    const condId   = !idVal   || liId.includes(idVal);
    const condNome = !nomeVal || liNome.includes(nomeVal);
    const condData = !dataVal || liDate === dataVal;
    const condTipo = !tipoVal || liTipo === tipoVal;

    linha.style.display = (condId && condNome && condData && condTipo) ? '' : 'none';
  });
}

// Eventos
['filtro-id','filtro-nome','filtro-data','filtro-tipo'].forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener(id === 'filtro-tipo' ? 'change' : 'input', filtrarTabela);
});

// Botão limpar filtros
document.getElementById('btn-limpar').addEventListener('click', () => {
  ['filtro-id','filtro-nome','filtro-data','filtro-tipo'].forEach(id => {
    document.getElementById(id).value = '';
  });
  filtrarTabela();
});

// aplica no carregamento
filtrarTabela();
</script>
{% endblock %}
